<html class="writer-html5 translated-ltr" lang="en" style="height: 100%;"><head>
    <meta charset="utf-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>10. AOS VFS — BL602 IoT SDK release_bl_iot_sdk_1.6.11-1-g66bb28da document</title>
    
  
    
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css">
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css">
    <link rel="stylesheet" href="../../../_static/style.css" type="text/css">
    <link rel="stylesheet" href="../../../_static/css/custom.css" type="text/css">
  
    
    
    
    
  
    
    <!--[if lt IE 9]>
      <script src="../../../_static/js/html5shiv.min.js"></script>
    <![endif]-->
    
      
        <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
          <script src="../../../_static/jquery.js"></script>
          <script src="../../../_static/underscore.js"></script>
          <script src="../../../_static/doctools.js"></script>
          <script src="../../../_static/language_data.js"></script>
      
      <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  
      
      <link rel="index" title="index" href="../../../genindex.html">
      <link rel="search" title="search for" href="../../../search.html">
      <link rel="next" title="11. yloop" href="../yloop/yloop.html">
      <link rel="prev" title="9. Security" href="../security/security.html"> 
  <script>(function(){(function injection() {
    var pageLang = 'auto';
    var userLang = 'en';
  
    var uid = '1E07F158C6FA4460B352973E9693B329';
    var teId = 'TE_' + uid;
    var cbId = 'TECB_' + uid;
  
    function show() {
      window.setTimeout(function() {
        window[teId].showBanner(true);
      }, 10);
    }
  
    function newElem() {
      var elem = new google.translate.TranslateElement({
        autoDisplay: false,
        floatPosition: 0,
        multilanguagePage: true,
        pageLanguage: pageLang
      });
      return elem;
    }
  
    if (window[teId]) {
      show();
    } else {
      if (!window.google || !google.translate ||
          !google.translate.TranslateElement) {
        if (!window[cbId]) {
          window[cbId] = function() {
            window[teId] = newElem();
            show();
          };
        }
        var s = document.createElement('script');
        s.src = 'https://translate.google.com/translate_a/element.js?cb=' +
                encodeURIComponent(cbId) + '&client=tee&hl=' + userLang;
        document.getElementsByTagName('head')[0].appendChild(s);
      }
    }
  })();})();</script><link type="text/css" rel="stylesheet" charset="UTF-8" href="https://translate.googleapis.com/translate_static/css/translateelement.css"><script type="text/javascript" charset="UTF-8" src="https://translate.googleapis.com/element/TE_20200506_00/e/js/element/element_main.js"></script></head>
  
  <body class="wy-body-for-nav" style="position: relative; min-height: 100%; top: 40px;">
  
     
    <div class="wy-grid-for-nav">
      
      <nav data-toggle="wy-nav-shift" class="wy-nav-side">
        <div class="wy-side-scroll">
          <div class="wy-side-nav-search">
            
  
            
              <a href="../../../index.html" class="icon icon-home" alt="Documentation Home"> BL602 IoT SDK
            
  
            
            </a>
  
            
              
              
                <div class="version">
                  release_bl_iot_sdk_1.6.11-1-g66bb28da
                </div>
              
            
  
            
  <div role="search">
    <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
      <input type="text" name="q" placeholder="Search in the document">
      <input type="hidden" name="check_keywords" value="yes">
      <input type="hidden" name="area" value="default">
    </form>
  </div>
  
            
          </div>
  
          
          <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
            
              
              
                
              
              
                <p class="caption"><span class="caption-text">Developer_Environment</span></p>
  <ul>
  <li class="toctree-l1"><a class="reference internal" href="../../../Developer_Environment/Developer_Environment.html">1. Developer Environment</a></li>
  <li class="toctree-l1"><a class="reference internal" href="../../../Developer_Environment/BLFlashEnv/BLFlashEnv.html">2. BLFlashEnv</a></li>
  <li class="toctree-l1"><a class="reference internal" href="../../../Developer_Environment/freedom_studio/freedom_studio.html">3. Freedom Studio</a></li>
  <li class="toctree-l1"><a class="reference internal" href="../../../Developer_Environment/eclipse/eclipse.html">4. Eclipse</a></li>
  </ul>
  <p class="caption"><span class="caption-text">Examples</span></p>
  <ul>
  <li class="toctree-l1"><a class="reference internal" href="../../../Examples/helloworld/helloworld.html">1. Helloword</a></li>
  <li class="toctree-l1"><a class="reference internal" href="../../../Examples/demo_aws/aws.html">2. aws</a></li>
  <li class="toctree-l1"><a class="reference internal" href="../../../Examples/demo_peripherals_gpio/GPIO.html">3. GPIO</a></li>
  <li class="toctree-l1"><a class="reference internal" href="../../../Examples/demo_peripherals_uart_echo/uart_echo.html">4. UART_echo</a></li>
  <li class="toctree-l1"><a class="reference internal" href="../../../Examples/demo_peripherals_uart_ioctl/uart_ioctl.html">5. UART_ioctl</a></li>
  <li class="toctree-l1"><a class="reference internal" href="../../../Examples/demo_protocols_http/http.html">6. Http client</a></li>
  <li class="toctree-l1"><a class="reference internal" href="../../../Examples/demo_protocols_httpc/httpc.html">7. Httpc client</a></li>
  <li class="toctree-l1"><a class="reference internal" href="../../../Examples/demo_storage_psm/psm.html">8. PSM</a></li>
  <li class="toctree-l1"><a class="reference internal" href="../../../Examples/demo_storage_romfs/romfs.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">9. Romfs</font></font></a></li>
  <li class="toctree-l1"><a class="reference internal" href="../../../Examples/demo_system_cli/cli.html">10. cli</a></li>
  <li class="toctree-l1"><a class="reference internal" href="../../../Examples/demo_system_fdt/fdt.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">11. FDT</font></font></a></li>
  <li class="toctree-l1"><a class="reference internal" href="../../../Examples/demo_wifi/wifi.html">12. WiFi</a></li>
  <li class="toctree-l1"><a class="reference internal" href="../../../Examples/demo_ble/ble.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">13. BLE</font></font></a></li>
  <li class="toctree-l1"><a class="reference internal" href="../../../Examples/demo_mesh/mesh.html">14. Mesh</a></li>
  <li class="toctree-l1"><a class="reference internal" href="../../../Examples/demo_blsync_ble/blsync_ble.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">15. BLSYNC-BLE</font></font></a></li>
  <li class="toctree-l1"><a class="reference internal" href="../../../Examples/sdk_app_easyflash_boottimes/easyflash_boottimes.html">16. Easyflash4 boot times</a></li>
  </ul>
  <p class="caption"><span class="caption-text">Components</span></p>
  <ul class="current">
  <li class="toctree-l1"><a class="reference internal" href="../../arch.html">1. arch</a></li>
  <li class="toctree-l1"><a class="reference internal" href="../../Command_line/helper.html">2. helper</a></li>
  <li class="toctree-l1"><a class="reference internal" href="../../Command_line/aos_cli.html">3. cli</a></li>
  <li class="toctree-l1"><a class="reference internal" href="../../Hal_drv/gpio.html">4. GPIO</a></li>
  <li class="toctree-l1"><a class="reference internal" href="../bloop/bloop.html">5. BLOOP</a></li>
  <li class="toctree-l1"><a class="reference internal" href="../blsync/blsync.html">6. BLSYNC</a></li>
  <li class="toctree-l1"><a class="reference internal" href="../dts/devicetree.html">7. device tree</a></li>
  <li class="toctree-l1"><a class="reference internal" href="../log/blog.html">8. blog</a></li>
  <li class="toctree-l1"><a class="reference internal" href="../security/security.html">9. Security</a></li>
  <li class="toctree-l1 current"><a class="reference internal current" href="#"><span class="toctree-expand"></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10. TO VFS</font></font></a><ul>
  <li class="toctree-l2"><a class="reference internal" href="#id1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10.1. Overview</font></font></a></li>
  <li class="toctree-l2"><a class="reference internal" href="#vfs"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10.2. Standard interface provided by VFS</font></font></a></li>
  <li class="toctree-l2"><a class="reference internal" href="#id2"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10.3. Data structure of VFS</font></font></a></li>
  <li class="toctree-l2"><a class="reference internal" href="#aos-open"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10.4. Take aos_open as an example to introduce its file opening method</font></font></a></li>
  <li class="toctree-l2"><a class="reference internal" href="#id3"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10.5. Load the driver file or file system into the VFS</font></font></a></li>
  <li class="toctree-l2"><a class="reference internal" href="#id4"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10.6. Sample code</font></font></a></li>
  <li class="toctree-l2"><a class="reference internal" href="#id5"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10.7. Summary</font></font></a></li>
  </ul>
  </li>
  <li class="toctree-l1"><a class="reference internal" href="../yloop/yloop.html">11. yloop</a></li>
  <li class="toctree-l1"><a class="reference internal" href="../../Network/httpc/httpc.html">12. HTTPC</a></li>
  <li class="toctree-l1"><a class="reference internal" href="../../Network/https/https.html">13. HTTPS</a></li>
  <li class="toctree-l1"><a class="reference internal" href="../../Network/tls/tls.html">14. TLS</a></li>
  <li class="toctree-l1"><a class="reference internal" href="../../BLE/provision_WiFi/provision_WiFi.html">15. Provision_WiFi</a></li>
  <li class="toctree-l1"><a class="reference internal" href="../../BLE/mesh/mesh.html">16. Mesh</a></li>
  <li class="toctree-l1"><a class="reference internal" href="../../BLE/ble_stack/ble_stack.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">17. BLE</font></font></a></li>
  </ul>
  <p class="caption"><span class="caption-text">API</span></p>
  <ul>
  <li class="toctree-l1"><a class="reference internal" href="../../../API/sys/cronalarms.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. cronalarms</font></font></a></li>
  <li class="toctree-l1"><a class="reference internal" href="../../../API/wifi/wifi_mgmr.html">2. Wi-Fi Manager</a></li>
  </ul>
  
              
            
          </div>
          
        </div>
      </nav>
  
      <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
  
        
        <nav class="wy-nav-top" aria-label="top navigation">
          
            <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
            <a href="../../../index.html">BL602 IoT SDK</a>
          
        </nav>
  
  
        <div class="wy-nav-content">
          
          <div class="rst-content">
          
            
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <div role="navigation" aria-label="breadcrumbs navigation">
  
    <ul class="wy-breadcrumbs">
      
        <li><a href="../../../index.html" class="icon icon-home"></a> »</li>
          
        <li><span class="section-number"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10.</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> TO VFS</font></font></li>
      
      
        <li class="wy-breadcrumbs-aside">
          
              
              <a href="../../../_sources/Components/Middleware/vfs/vfs.rst.txt" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> View page source code</font></font></a>
            
          
        </li>
      
    </ul>
  
    
    <hr>
  </div>
            <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
             <div itemprop="articleBody">
              
    <div class="section" id="aos-vfs">
  <h1><span class="section-number"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10.</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> TO VFS</font></font><a class="headerlink" href="#aos-vfs" title="Permalink to title">¶</a></h1>
  <ul class="simple">
  <li><p><a class="reference internal" href="#id1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Overview</font></font></a></p></li>
  <li><p><a class="reference internal" href="#vfs"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Standard interface provided by VFS</font></font></a></p></li>
  <li><p><a class="reference internal" href="#id2"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VFS data structure</font></font></a></p></li>
  <li><p><a class="reference internal" href="#aos-open"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Take aos_open as an example to introduce its file opening method</font></font></a></p></li>
  <li><p><a class="reference internal" href="#id3"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Load the driver file or file system into the VFS</font></font></a></p></li>
  <li><p><a class="reference internal" href="#id4"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sample code</font></font></a></p></li>
  <li><p><a class="reference internal" href="#id5"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to sum up</font></font></a></p></li>
  </ul>
  <div class="section" id="id1">
  <h2><span class="section-number"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10.1.</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Overview</font></font><a class="headerlink" href="#id1" title="Permalink to title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¶</font></font></a></h2>
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The significance of VFS, shields the difference of the underlying file system, and provides a standard system call interface for the application layer.</font></font></p>
  </div>
  <div class="section" id="vfs">
  <h2><span class="section-number"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10.2.</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Standard interface provided by VFS</font></font><a class="headerlink" href="#vfs" title="Permalink to title">¶</a></h2>
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The basic common UNIX interfaces have been implemented. </font><font style="vertical-align: inherit;">It has a prefix </font></font><code class="docutils literal notranslate"><span class="pre">aos_</span></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Because these are external interfaces, it is stipulated in the code naming rules of AliOS Things: All external interfaces need to be prefixed</font></font><code class="docutils literal notranslate"><span class="pre">aos_</span></code></p>
  <p>aos_open</p>
  <p>aos_close</p>
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aos_read</font></font></p>
  <p>aos_write</p>
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aos_ioctl</font></font></p>
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aos_poll</font></font></p>
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aos_fcnt</font></font></p>
  <p>aos_lseek</p>
  <p>aos_sync</p>
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aos_stat</font></font></p>
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aos_unlink</font></font></p>
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aos_rename</font></font></p>
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aos_opendir</font></font></p>
  <p>aos_closedir</p>
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aos_readdir</font></font></p>
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aos_mkdir</font></font></p>
  </div>
  <div class="section" id="id2">
  <h2><span class="section-number"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10.3.</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Data structure of VFS</font></font><a class="headerlink" href="#id2" title="Permalink to title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¶</font></font></a></h2>
  <p><code class="docutils literal notranslate"><span class="pre">inode_t</span></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">data structure</font></font></p>
  <div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/* this structure represents inode for driver and fs*/</span>
  <span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
      <span class="k">union</span> <span class="n">inode_ops_t</span> <span class="n">ops</span><span class="p">;</span>     <span class="cm">/* inode operations */</span>
      <span class="kt">void</span>             <span class="o">*</span><span class="n">i_arg</span><span class="p">;</span>   <span class="cm">/* per inode private data */</span>
      <span class="kt">char</span>             <span class="o">*</span><span class="n">i_name</span><span class="p">;</span>  <span class="cm">/* name of inode */</span>
      <span class="kt">int</span>               <span class="n">i_flags</span><span class="p">;</span> <span class="cm">/* flags for inode */</span>
      <span class="kt">uint8_t</span>           <span class="n">type</span><span class="p">;</span>    <span class="cm">/* type for inode */</span>
      <span class="kt">uint8_t</span>           <span class="n">refs</span><span class="p">;</span>    <span class="cm">/* refs for inode */</span>
  <span class="p">}</span> <span class="n">inode_t</span><span class="p">;</span>
  </pre></div>
  </div>
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Because the VFS virtual file system treats files and directories as files, the above data structure is an index node type, which has the operation method of the node, the data storage pointer of the node, and the name of the node (that is, the node path name/dev/null ), node type, number of times the node is referenced.</font></font></p>
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the </font></font><code class="docutils literal notranslate"><span class="pre">inode_</span></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">t structure, ops is the operation method for index nodes, as follows:</font></font></p>
  <div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">union</span> <span class="n">inode_ops_t</span> <span class="p">{</span>
  
      <span class="k">const</span> <span class="n">file_ops_t</span> <span class="o">*</span><span class="n">i_ops</span><span class="p">;</span>  <span class="cm">/* char driver operations */</span>
  
      <span class="k">const</span> <span class="n">fs_ops_t</span>   <span class="o">*</span><span class="n">i_fops</span><span class="p">;</span> <span class="cm">/* FS operations */</span>
  
  <span class="p">};</span>
  <span class="k">typedef</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_ops</span> <span class="n">file_ops_t</span><span class="p">;</span> <span class="cm">/* 针对文件的操作方法 */</span>
  <span class="k">typedef</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">fs_ops</span>   <span class="n">fs_ops_t</span><span class="p">;</span>   <span class="cm">/* 针对目录的操作方法 */</span>
  <span class="k">struct</span> <span class="n">file_ops</span> <span class="p">{</span>
      <span class="kt">int</span>     <span class="p">(</span><span class="o">*</span><span class="n">open</span><span class="p">)</span>  <span class="p">(</span><span class="n">inode_t</span> <span class="o">*</span><span class="n">node</span><span class="p">,</span> <span class="n">file_t</span> <span class="o">*</span><span class="n">fp</span><span class="p">);</span>
      <span class="kt">int</span>     <span class="p">(</span><span class="o">*</span><span class="n">close</span><span class="p">)</span> <span class="p">(</span><span class="n">file_t</span> <span class="o">*</span><span class="n">fp</span><span class="p">);</span>
      <span class="kt">ssize_t</span> <span class="p">(</span><span class="o">*</span><span class="n">read</span><span class="p">)</span>  <span class="p">(</span><span class="n">file_t</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">nbytes</span><span class="p">);</span>
      <span class="kt">ssize_t</span> <span class="p">(</span><span class="o">*</span><span class="n">write</span><span class="p">)</span> <span class="p">(</span><span class="n">file_t</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">nbytes</span><span class="p">);</span>
      <span class="kt">int</span>     <span class="p">(</span><span class="o">*</span><span class="n">ioctl</span><span class="p">)</span> <span class="p">(</span><span class="n">file_t</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">);</span>
  <span class="cp">#ifdef AOS_CONFIG_VFS_POLL_SUPPORT</span>
      <span class="kt">int</span>     <span class="p">(</span><span class="o">*</span><span class="n">poll</span><span class="p">)</span>  <span class="p">(</span><span class="n">file_t</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">flag</span><span class="p">,</span> <span class="n">poll_notify_t</span> <span class="n">notify</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pollfd</span> <span class="o">*</span><span class="n">fd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">);</span>
  <span class="cp">#endif</span>
  <span class="p">};</span>
  <span class="k">struct</span> <span class="n">fs_ops</span> <span class="p">{</span>
      <span class="kt">int</span>             <span class="p">(</span><span class="o">*</span><span class="n">open</span><span class="p">)</span>     <span class="p">(</span><span class="n">file_t</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">);</span>
      <span class="kt">int</span>             <span class="p">(</span><span class="o">*</span><span class="n">close</span><span class="p">)</span>    <span class="p">(</span><span class="n">file_t</span> <span class="o">*</span><span class="n">fp</span><span class="p">);</span>
      <span class="kt">ssize_t</span>         <span class="p">(</span><span class="o">*</span><span class="n">read</span><span class="p">)</span>     <span class="p">(</span><span class="n">file_t</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">);</span>
      <span class="kt">ssize_t</span>         <span class="p">(</span><span class="o">*</span><span class="n">write</span><span class="p">)</span>    <span class="p">(</span><span class="n">file_t</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">);</span>
      <span class="kt">off_t</span>           <span class="p">(</span><span class="o">*</span><span class="n">lseek</span><span class="p">)</span>    <span class="p">(</span><span class="n">file_t</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="kt">off_t</span> <span class="n">off</span><span class="p">,</span> <span class="kt">int</span> <span class="n">whence</span><span class="p">);</span>
      <span class="kt">int</span>             <span class="p">(</span><span class="o">*</span><span class="n">sync</span><span class="p">)</span>     <span class="p">(</span><span class="n">file_t</span> <span class="o">*</span><span class="n">fp</span><span class="p">);</span>
      <span class="kt">int</span>             <span class="p">(</span><span class="o">*</span><span class="n">stat</span><span class="p">)</span>     <span class="p">(</span><span class="n">file_t</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="k">struct</span> <span class="n">stat</span> <span class="o">*</span><span class="n">st</span><span class="p">);</span>
      <span class="kt">int</span>             <span class="p">(</span><span class="o">*</span><span class="n">unlink</span><span class="p">)</span>   <span class="p">(</span><span class="n">file_t</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">);</span>
      <span class="kt">int</span>             <span class="p">(</span><span class="o">*</span><span class="n">rename</span><span class="p">)</span>   <span class="p">(</span><span class="n">file_t</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">oldpath</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">newpath</span><span class="p">);</span>
      <span class="n">aos_dir_t</span>      <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">opendir</span><span class="p">)</span>  <span class="p">(</span><span class="n">file_t</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">);</span>
      <span class="n">aos_dirent_t</span>   <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">readdir</span><span class="p">)</span>  <span class="p">(</span><span class="n">file_t</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="n">aos_dir_t</span> <span class="o">*</span><span class="n">dir</span><span class="p">);</span>
      <span class="kt">int</span>             <span class="p">(</span><span class="o">*</span><span class="n">closedir</span><span class="p">)</span> <span class="p">(</span><span class="n">file_t</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="n">aos_dir_t</span> <span class="o">*</span><span class="n">dir</span><span class="p">);</span>
      <span class="kt">int</span>             <span class="p">(</span><span class="o">*</span><span class="n">mkdir</span><span class="p">)</span>    <span class="p">(</span><span class="n">file_t</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">);</span>
      <span class="kt">int</span>             <span class="p">(</span><span class="o">*</span><span class="n">rmdir</span><span class="p">)</span>    <span class="p">(</span><span class="n">file_t</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">);</span>
      <span class="kt">void</span>            <span class="p">(</span><span class="o">*</span><span class="n">rewinddir</span><span class="p">)(</span><span class="n">file_t</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="n">aos_dir_t</span> <span class="o">*</span><span class="n">dir</span><span class="p">);</span>
      <span class="kt">long</span>            <span class="p">(</span><span class="o">*</span><span class="n">telldir</span><span class="p">)</span>  <span class="p">(</span><span class="n">file_t</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="n">aos_dir_t</span> <span class="o">*</span><span class="n">dir</span><span class="p">);</span>
      <span class="kt">void</span>            <span class="p">(</span><span class="o">*</span><span class="n">seekdir</span><span class="p">)</span>  <span class="p">(</span><span class="n">file_t</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="n">aos_dir_t</span> <span class="o">*</span><span class="n">dir</span><span class="p">,</span> <span class="kt">long</span> <span class="n">loc</span><span class="p">);</span>
      <span class="kt">int</span>             <span class="p">(</span><span class="o">*</span><span class="n">ioctl</span><span class="p">)</span>    <span class="p">(</span><span class="n">file_t</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">);</span>
      <span class="kt">int</span>             <span class="p">(</span><span class="o">*</span><span class="n">statfs</span><span class="p">)</span>   <span class="p">(</span><span class="n">file_t</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="k">struct</span> <span class="n">statfs</span> <span class="o">*</span><span class="n">suf</span><span class="p">);</span>
      <span class="kt">int</span>             <span class="p">(</span><span class="o">*</span><span class="n">access</span><span class="p">)</span>   <span class="p">(</span><span class="n">file_t</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="kt">int</span> <span class="n">amode</span><span class="p">);</span>
  <span class="p">};</span>
  </pre></div>
  </div>
  <p><code class="docutils literal notranslate"><span class="pre">file_t</span></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">data structure</font></font></p>
  <div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
      <span class="n">inode_t</span>    <span class="o">*</span><span class="n">node</span><span class="p">;</span>   <span class="cm">/* node for file */</span>
      <span class="kt">void</span>       <span class="o">*</span><span class="n">f_arg</span><span class="p">;</span>  <span class="cm">/* f_arg for file */</span>
      <span class="kt">size_t</span>     <span class="n">offset</span><span class="p">;</span> <span class="cm">/* offset for file */</span>
  <span class="p">}</span> <span class="n">file_t</span><span class="p">;</span>
  </pre></div>
  </div>
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The above </font></font><code class="docutils literal notranslate"><span class="pre">file_t</span></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">data structure is used to describe an opened file, because in the same system in the system, the same file may be opened by multiple programs, but each opened file will uniquely execute a specific index node, that is, the final physical There is only one file.</font></font></p>
  </div>
  <div class="section" id="aos-open">
  <h2><span class="section-number"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10.4.</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Take aos_open as an example to introduce its file opening method</font></font><a class="headerlink" href="#aos-open" title="Permalink to title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¶</font></font></a></h2>
  <p><code class="docutils literal notranslate"><span class="pre">aos_open</span></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It is an external interface, and external functions can directly use this interface to implement file opening operations without worrying about the implementation details of the underlying file system. </font><font style="vertical-align: inherit;">The code is as follows:</font></font></p>
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The input parameters are:</font></font></p>
  <div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">const</span> <span class="n">char</span> <span class="o">*</span><span class="n">path</span><span class="p">;</span> <span class="n">即文件路径名</span>
  <span class="nb">int</span> <span class="n">flags</span><span class="p">;</span> <span class="n">即操作标志</span> <span class="n">比如只读</span> <span class="n">只写</span> <span class="n">读写等</span>
  </pre></div>
  </div>
  <div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">aos_open</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
  <span class="p">{</span>
      <span class="n">file_t</span>  <span class="o">*</span><span class="n">file</span><span class="p">;</span>
      <span class="n">inode_t</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>
      <span class="kt">size_t</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">VFS_SUCCESS</span><span class="p">;</span>
  
      <span class="k">if</span> <span class="p">(</span><span class="n">path</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
      <span class="p">}</span>
  
      <span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">PATH_MAX</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* 文件路径名不允许超过256个字节 */</span>
          <span class="k">return</span> <span class="o">-</span><span class="n">ENAMETOOLONG</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="cm">/* 获取互斥锁，该互斥锁在vfs_init函数中创建 */</span>
      <span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">krhino_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">g_vfs_mutex</span><span class="p">,</span> <span class="n">RHINO_WAIT_FOREVER</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="cm">/* 根据路径名传参，打开索引节点，具体函数实现会在下文介绍 */</span>
      <span class="n">node</span> <span class="o">=</span> <span class="n">inode_open</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
  
      <span class="k">if</span> <span class="p">(</span><span class="n">node</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">krhino_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">g_vfs_mutex</span><span class="p">);</span>
  
  <span class="cp">#ifdef IO_NEED_TRAP</span>
          <span class="k">return</span> <span class="n">trap_open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
  <span class="cp">#else</span>
          <span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
  <span class="cp">#endif</span>
      <span class="p">}</span>
  
      <span class="n">node</span><span class="o">-&gt;</span><span class="n">i_flags</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>
      <span class="cm">/*因为用户操作的文件都是在内存中新建立的文件（文件对象会反过来指向索引节点</span>
  <span class="cm">        即一个文件可能被多个程序打开）。所以需要根据索引接点对象新建立一个文件对象</span>
  <span class="cm">    */</span>
      <span class="n">file</span> <span class="o">=</span> <span class="n">new_file</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>
      <span class="cm">/* 释放互斥锁 */</span>
      <span class="n">krhino_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">g_vfs_mutex</span><span class="p">);</span>
  
      <span class="k">if</span> <span class="p">(</span><span class="n">file</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="o">-</span><span class="n">ENFILE</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="cm">/* 根据节点类型判断该路径名指向是一个文件还是一个目录，因为文件对象和目录对象虽然都是节点</span>
  <span class="cm">    但是其操作方法有些差别，见前文中的目录和文件操作方法 */</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">INODE_IS_FS</span><span class="p">(</span><span class="n">node</span><span class="p">))</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">((</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i_fops</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
              <span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i_fops</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">)(</span><span class="n">file</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
          <span class="p">}</span>
  
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">((</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i_ops</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
              <span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i_ops</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">)(</span><span class="n">node</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
          <span class="p">}</span>
      <span class="p">}</span>
  
      <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">VFS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">del_file</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
          <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="cm">/* 获得文件句柄 */</span>
      <span class="k">return</span> <span class="n">get_fd</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
  <span class="p">}</span>
  </pre></div>
  </div>
  <ul class="simple">
  <li><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">inode_open The inode_open function is used to open the corresponding node according to the file path name. </font><font style="vertical-align: inherit;">The input parameters are: the </font><font style="vertical-align: inherit;">output parameters are:
  </font></font><code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">char</span> <span class="pre">*</span> <span class="pre">path;</span> <span class="pre">文件路径名</span></code><font style="vertical-align: inherit;"></font><code class="docutils literal notranslate"><span class="pre">inode_t;</span> <span class="pre">对应的节点</span></code></p></li>
  </ul>
  <div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="n">inode_t</span> <span class="n">g_vfs_dev_nodes</span><span class="p">[</span><span class="n">AOS_CONFIG_VFS_DEV_NODES</span><span class="p">];</span>
  <span class="n">inode_t</span> <span class="o">*</span><span class="nf">inode_open</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">)</span>
  <span class="p">{</span>
      <span class="kt">int</span> <span class="n">e</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">inode_t</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>
      <span class="cm">/*AOS_CONFIG_VFS_DEV_NODES该宏定义为25.</span>
  <span class="cm">        即在保存节点的数组g_vfs_dev_nodes中仅仅会保存25个节点</span>
  <span class="cm">    */</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">e</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">e</span> <span class="o">&lt;</span> <span class="n">AOS_CONFIG_VFS_DEV_NODES</span><span class="p">;</span> <span class="n">e</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">node</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">g_vfs_dev_nodes</span><span class="p">[</span><span class="n">e</span><span class="p">];</span>
  
          <span class="k">if</span> <span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">i_name</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">continue</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="cm">/* 判断该节点是一个目录还是一个文件 */</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">INODE_IS_TYPE</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">VFS_TYPE_FS_DEV</span><span class="p">))</span> <span class="p">{</span>
              <span class="k">if</span> <span class="p">((</span><span class="n">strncmp</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">i_name</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">i_name</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                  <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">i_name</span><span class="p">))</span> <span class="o">==</span> <span class="sc">'/'</span><span class="p">))</span> <span class="p">{</span>
                  <span class="k">return</span> <span class="n">node</span><span class="p">;</span>
              <span class="p">}</span>
          <span class="p">}</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">i_name</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">return</span> <span class="n">node</span><span class="p">;</span>
          <span class="p">}</span>
      <span class="p">}</span>
  
      <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="p">}</span>
  </pre></div>
  </div>
  <ul class="simple">
  <li><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">new_file In the new_file() function, the main function completed is to create a new file_t structure definition and initialization. </font><font style="vertical-align: inherit;">The input parameter is: inode_t *node; The node output parameter obtained in the previous function is: file_t type. </font><font style="vertical-align: inherit;">Used to obtain the file handle later</font></font></p></li>
  </ul>
  <div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="n">file_t</span> <span class="n">files</span><span class="p">[</span><span class="n">MAX_FILE_NUM</span><span class="p">];</span>
  <span class="cp">#define MAX_FILE_NUM (AOS_CONFIG_VFS_DEV_NODES * 2)</span>
  <span class="n">file_t</span> <span class="o">*</span><span class="nf">new_file</span><span class="p">(</span><span class="n">inode_t</span> <span class="o">*</span><span class="n">node</span><span class="p">)</span>
  <span class="p">{</span>
      <span class="n">file_t</span> <span class="o">*</span><span class="n">f</span><span class="p">;</span>
      <span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
      <span class="cm">/* 在file数组当中新建立一个数据项。且保证该数组未满。即打开的文件数量是有限的 */</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">MAX_FILE_NUM</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">f</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">files</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
  
          <span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">node</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">goto</span> <span class="n">got_file</span><span class="p">;</span>
          <span class="p">}</span>
      <span class="p">}</span>
  
      <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
  
  <span class="nl">got_file</span><span class="p">:</span>
      <span class="n">f</span><span class="o">-&gt;</span><span class="n">node</span> <span class="o">=</span> <span class="n">node</span><span class="p">;</span>
      <span class="n">f</span><span class="o">-&gt;</span><span class="n">f_arg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
      <span class="n">f</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">inode_ref</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">f</span><span class="p">;</span>
  <span class="p">}</span>
  </pre></div>
  </div>
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">All system call functions (similar to aos_open) are located in the vfs.c file.</font></font></p>
  </div>
  <div class="section" id="id3">
  <h2><span class="section-number"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10.5.</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Load the driver file or file system into the VFS</font></font><a class="headerlink" href="#id3" title="Permalink to title">¶</a></h2>
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Functions defined in the vfs_register.c file:</font></font></p>
  <div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="n">aos_register_driver</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="n">file_ops_t</span> <span class="o">*</span><span class="n">ops</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
  <span class="kt">int</span> <span class="n">aos_register_fs</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="n">fs_ops_t</span> <span class="o">*</span><span class="n">ops</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
  </pre></div>
  </div>
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The above two functions are functions to load the driver file or the file system type into the VFS respectively. </font><font style="vertical-align: inherit;">External programs (such as sensor driver) can call these two interfaces to load the driver file into the VFS.</font></font></p>
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Take aos_register_driver as an example to introduce:</font></font></p>
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The input parameters are: Drive file path name const char * path (/dev/null)</font></font></p>
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Drive operation method file_ops_t *ops (do not need to implement all methods, implement necessary methods, and the rest can be set to NULL)</font></font></p>
  <div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">aos_register_driver</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="n">file_ops_t</span> <span class="o">*</span><span class="n">ops</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
  <span class="p">{</span>
      <span class="n">inode_t</span> <span class="o">*</span><span class="n">node</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
      <span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
  
      <span class="n">err</span> <span class="o">=</span> <span class="n">krhino_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">g_vfs_mutex</span><span class="p">,</span> <span class="n">RHINO_WAIT_FOREVER</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
      <span class="p">}</span>
  <span class="c1">//在g_vfs_dev_nodes数组中寻找一个空的数组项，返回其指针给node，并将path的路径名赋给node--&gt;name</span>
      <span class="n">ret</span> <span class="o">=</span> <span class="n">inode_reserve</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">node</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">VFS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
          <span class="cm">/* now populate it with char specific information */</span>
          <span class="n">INODE_SET_CHAR</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>
  
          <span class="n">node</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i_ops</span> <span class="o">=</span> <span class="n">ops</span><span class="p">;</span>
          <span class="n">node</span><span class="o">-&gt;</span><span class="n">i_arg</span>     <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
      <span class="p">}</span>
  
      <span class="cm">/* step out critical area for type is allocated */</span>
      <span class="n">err</span> <span class="o">=</span> <span class="n">krhino_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">g_vfs_mutex</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">i_name</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
              <span class="n">krhino_mm_free</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">i_name</span><span class="p">);</span>
          <span class="p">}</span>
  
          <span class="n">memset</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">inode_t</span><span class="p">));</span>
          <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
      <span class="p">}</span>
  
      <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
  <span class="p">}</span>
  </pre></div>
  </div>
  </div>
  <div class="section" id="id4">
  <h2><span class="section-number"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10.6.</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Sample code</font></font><a class="headerlink" href="#id4" title="Permalink to title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¶</font></font></a></h2>
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">linux vfs class operation in operation, where for example </font></font><code class="docutils literal notranslate"><span class="pre">aos_open</span></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code class="docutils literal notranslate"><span class="pre">aos_close</span></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code class="docutils literal notranslate"><span class="pre">aos_read</span></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">,</font></font><code class="docutils literal notranslate"><span class="pre">aos_write</span></code></p>
  <div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">bl_test_uart0</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
  <span class="p">{</span>
      <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>
      <span class="kt">int</span> <span class="n">length</span><span class="p">;</span>
      <span class="kt">char</span> <span class="n">buf_recv</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
  
      <span class="cm">/* 首先打开相关文件，对应到UART0 */</span>
      <span class="n">fd</span> <span class="o">=</span> <span class="n">aos_open</span><span class="p">(</span><span class="s">"/dev/ttyS0"</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">log_error</span><span class="p">(</span><span class="s">"open err.</span><span class="se">\r\n</span><span class="s">"</span><span class="p">);</span>
          <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
  
      <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
          <span class="cm">/* 读取UART0中的数据 */</span>
          <span class="n">length</span> <span class="o">=</span> <span class="n">aos_read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf_recv</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf_recv</span><span class="p">));</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
  
              <span class="n">log_info</span><span class="p">(</span><span class="s">"recv len = %d</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
  
              <span class="cm">/* 直到收到'exit'才会主动结束循环，并close相关文件 */</span>
              <span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">buf_recv</span><span class="p">,</span> <span class="s">"exit"</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                  <span class="n">aos_close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
                  <span class="k">break</span><span class="p">;</span>
              <span class="p">}</span>
  
              <span class="cm">/* UART0将收到的数据回传过去 */</span>
              <span class="n">aos_write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf_recv</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="n">vTaskDelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
      <span class="p">}</span>
  <span class="p">}</span>
  </pre></div>
  </div>
  </div>
  <div class="section" id="id5">
  <h2><span class="section-number"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10.7.</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Summary</font></font><a class="headerlink" href="#id5" title="Permalink to title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¶</font></font></a></h2>
  <ul class="simple">
  <li><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">An important mutex of the VFS requires the acquisition of the mutex to perform related operations on the VFS.
  </font></font><code class="docutils literal notranslate"><span class="pre">kmutex_t</span> <span class="pre">g_vfs_mutex;</span></code></p></li>
  <li><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The two important array structures of VFS are as follows: The first array is an array structure for storing nodes. </font><font style="vertical-align: inherit;">The second array is an array structure that holds file objects. </font><font style="vertical-align: inherit;">Directly related to the user is the second array structure</font></font></p></li>
  </ul>
  <div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="n">inode_t</span> <span class="n">g_vfs_dev_nodes</span><span class="p">[</span><span class="n">AOS_CONFIG_VFS_DEV_NODES</span><span class="p">];</span>
  <span class="k">static</span> <span class="n">file_t</span> <span class="n">files</span><span class="p">[</span><span class="n">MAX_FILE_NUM</span><span class="p">];</span>
  </pre></div>
  </div>
  <ul class="simple">
  <li><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The file vfs_register.c that users only need to care about is used to register the vfs.c file for various standard operations.</font></font></p></li>
  </ul>
  </div>
  </div>
  
  
             </div>
             
            </div>
            <footer>
    
      <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        
          <a href="../yloop/yloop.html" class="btn btn-neutral float-right" title="11. yloop" accesskey="n" rel="next"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Next page </font></font><span class="fa fa-arrow-circle-right"></span></a>
        
        
          <a href="../security/security.html" class="btn btn-neutral float-left" title="9. Security" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Previous page</font></font></a>
        
      </div>
    
  
    <hr>
  
    <div role="contentinfo">
      <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          
          © Copyright 2020, Bouffalo Lab
  
      </font></font></p>
    </div><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      
      
      
      Use </font></font><a href="http://sphinx-doc.org/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sphinx</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> constructed, using the 
      
       </font></font><a href="https://github.com/rtfd/sphinx_rtd_theme"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">theme</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
      
      of </font></font><a href="https://readthedocs.org"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Read the Docs</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> development. 
  
  </font></font></footer>
  
          </div>
        </div>
  
      </section>
  
    </div>
    
  
    <script type="text/javascript">
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>
  
    
    
      
     
  
  
  </body></html>